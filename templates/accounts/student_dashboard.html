{% extends 'base.html' %}
{% block title %}Student Dashboard - PlacementHub{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card p-4 text-center mb-4 border-0 shadow-sm" style="border-radius: 20px; background: white;">
            <div class="mb-3">
                {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" class="rounded-circle"
                    style="width: 100px; height: 100px; object-fit: cover; border: 3px solid #f0f4f8;">
                {% else %}
                <div class="bg-light text-secondary rounded-circle d-inline-flex align-items-center justify-content-center"
                    style="width: 100px; height: 100px;">
                    <i class="bi bi-person-fill fs-1"></i>
                </div>
                {% endif %}
            </div>
            <h5 class="fw-bold mb-1">{{ user.get_full_name|default:user.username }}</h5>
            <p class="text-primary small fw-semibold text-uppercase mb-3">Student Profile</p>
            <div class="d-grid">
                <a href="#" class="btn btn-primary btn-sm rounded-pill py-2 fw-bold">Edit Profile</a>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Welcome back, <span class="text-primary">{{ user.first_name|default:user.username
                    }}</span>!</h2>
        </div>

        <div id="readiness-data" data-labels="{{ chart_labels|safe }}" data-scores="{{ chart_data|safe }}"
            style="display:none;"></div>

        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card p-3 border-0 shadow-sm h-100" style="border-radius: 16px;">
                    <h6 class="text-secondary small fw-bold text-uppercase mb-2">Readiness Score</h6>
                    <h2 class="fw-bold text-primary mb-0">{{ avg_readiness }}%</h2>
                    <small class="text-muted">Avg. Performance</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-0 shadow-sm h-100" style="border-radius: 16px;">
                    <h6 class="text-secondary small fw-bold text-uppercase mb-2">Mock Tests</h6>
                    <h2 class="fw-bold text-success mb-0">{{ tests_taken }}</h2>
                    <small class="text-muted">Total Attempts</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-0 shadow-sm h-100" style="border-radius: 16px;">
                    <h6 class="text-secondary small fw-bold text-uppercase mb-2">Active Drives</h6>
                    <h2 class="fw-bold text-warning mb-0">{{ active_drives }}</h2>
                    <small class="text-muted">Opportunities</small>
                </div>
            </div>
        </div>

        <div class="card p-0 border-0 shadow-sm mb-4"
            style="border-radius: 20px; overflow: hidden; background: #0f172a;">
            <div class="p-4 d-flex justify-content-between align-items-center position-absolute w-100"
                style="z-index: 10; pointer-events: none;">
                <h5 class="fw-bold text-white mb-0">Performance Analytics</h5>
                <span class="badge bg-primary rounded-pill px-3 py-2" style="pointer-events: auto;">3D Bar
                    Analytics</span>
            </div>
            <div id="readiness-3d-wrapper"
                style="width: 100%; height: 400px; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); position: relative;">
                <div id="readiness-tooltip-3d"
                    style="position: absolute; display: none; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); color: white; padding: 10px; border-radius: 10px; border: 1px solid rgba(79, 70, 229, 0.5); pointer-events: none; z-index: 100; font-family: 'Inter', sans-serif;">
                </div>
            </div>
        </div>

        {% if latest_attempts %}
        <div class="card p-4 border-0 shadow-sm" style="border-radius: 20px;">
            <h5 class="fw-bold mb-3">Recent Test Results</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Test Title</th>
                            <th>Score</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attempt in latest_attempts %}
                        <tr>
                            <td class="fw-bold">{{ attempt.test.title }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="me-2">{{ attempt.score }}/{{ attempt.total_marks }}</span>
                                    {% widthratio attempt.score attempt.total_marks 100 as perc %}
                                    <div class="progress flex-grow-1" style="height: 6px; min-width: 60px;">
                                        <div class="progress-bar {% if perc|add:0 >= 70 %}bg-success{% elif perc|add:0 >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
                                            style="width: {{ perc }}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-muted small">{{ attempt.completed_at|date:"d M, Y" }}</td>
                            <td>
                                {% widthratio attempt.score attempt.total_marks 100 as percentage %}
                                {% if percentage|add:0 >= 70 %}
                                <span
                                    class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 border-0">Qualified</span>
                                {% else %}
                                <span
                                    class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3 border-0">Needs
                                    Practice</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    (function () {
        const wrapper = document.getElementById('readiness-3d-wrapper');
        const tooltip = document.getElementById('readiness-tooltip-3d');
        const dataNode = document.getElementById('readiness-data');
        if (!wrapper || !dataNode) return;

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, wrapper.clientWidth / wrapper.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(wrapper.clientWidth, wrapper.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        wrapper.appendChild(renderer.domElement);

        const group = new THREE.Group();
        scene.add(group);

        let labels = [];
        let scores = [];
        try {
            labels = JSON.parse(dataNode.dataset.labels.replace(/'/g, '"'));
            scores = JSON.parse(dataNode.dataset.scores);
        } catch (e) {
            labels = ['Technical', 'Aptitude', 'Soft Skills'];
            scores = [85, 70, 95];
        }

        const data = labels.map((l, i) => ({ label: l, value: scores[i] || 0, color: 0x4f46e5 }));
        const maxVal = Math.max(...data.map(d => d.value), 100);
        const scale = 5 / maxVal;

        // Platform
        const platform = new THREE.Mesh(
            new THREE.CylinderGeometry(5.5, 6, 0.4, 32),
            new THREE.MeshPhongMaterial({ color: 0x1e293b, transparent: true, opacity: 0.8 })
        );
        platform.position.y = -0.2;
        group.add(platform);

        const bars = [];
        data.forEach((item, i) => {
            const h = Math.max(item.value * scale, 0.1);
            const geometry = new THREE.BoxGeometry(1, h, 1);
            const material = new THREE.MeshPhongMaterial({
                color: item.color,
                emissive: item.color,
                emissiveIntensity: 0.2,
                transparent: true,
                opacity: 0.85
            });
            const bar = new THREE.Mesh(geometry, material);

            const angle = (i / data.length) * Math.PI * 2;
            const radius = 3.5;
            bar.position.set(Math.cos(angle) * radius, h / 2, Math.sin(angle) * radius);
            bar.lookAt(0, h / 2, 0);
            bar.userData = { label: item.label, value: item.value };

            // Neon Edges
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.5 }));
            bar.add(line);

            bars.push(bar);
            group.add(bar);

            // Animation
            bar.scale.y = 0.01;
            bar.position.y = 0;
            const grow = () => {
                if (bar.scale.y < 1) {
                    bar.scale.y += 0.05;
                    bar.position.y = (h * bar.scale.y) / 2;
                    requestAnimationFrame(grow);
                }
            };
            setTimeout(grow, i * 150);
        });

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.PointLight(0x00ffff, 1.5, 20);
        light.position.set(5, 8, 5);
        scene.add(light);

        camera.position.set(8, 8, 8);
        camera.lookAt(0, 1, 0);

        const rc = new THREE.Raycaster();
        const m = new THREE.Vector2();

        wrapper.addEventListener('mousemove', (e) => {
            const rect = wrapper.getBoundingClientRect();
            m.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            m.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            rc.setFromCamera(m, camera);

            const intersects = rc.intersectObjects(bars);
            bars.forEach(b => {
                b.material.emissiveIntensity = 0.2;
                b.scale.x = b.scale.z = 1;
            });

            if (intersects.length > 0) {
                const b = intersects[0].object;
                b.material.emissiveIntensity = 0.8;
                b.scale.x = b.scale.z = 1.1;
                wrapper.style.cursor = 'pointer';
                tooltip.style.display = 'block';
                tooltip.innerHTML = `<strong>${b.userData.label}</strong><br>Score: ${b.userData.value}%`;
                tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                tooltip.style.top = (e.clientY - rect.top - 15) + 'px';
            } else {
                wrapper.style.cursor = 'default';
                tooltip.style.display = 'none';
            }
        });

        const animate = () => {
            requestAnimationFrame(animate);
            group.rotation.y += 0.003;
            renderer.render(scene, camera);
        };
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = wrapper.clientWidth / wrapper.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(wrapper.clientWidth, wrapper.clientHeight);
        });
    })();
</script>
{% endblock %}