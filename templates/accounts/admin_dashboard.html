{% extends 'base.html' %}
{% block title %}Admin Dashboard - PlacementHub{% endblock %}
{% block extra_css %}
<style>
    :root {
        --accent-primary: #1e3c72;
        --accent-secondary: #2a5298;
    }

    .stats-card {
        background: white;
        border-radius: 20px;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .action-btn {
        border-radius: 12px;
        padding: 12px 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
        background: #f8f9fa;
        text-decoration: none;
        color: #333;
        border: 1px solid #eee;
        margin-bottom: 10px;
        font-weight: 500;
    }

    .action-btn:hover {
        background: var(--accent-primary);
        color: white;
        transform: translateX(8px);
    }
</style>
{% endblock %}

{% block content %}
<div class="row align-items-end mb-4">
    <div class="col-md-8">
        <h1 class="fw-bold mb-1">Placement <span class="text-primary">Console</span></h1>
        <p class="text-muted mb-0">Unified system administration and strategic metrics</p>
    </div>
</div>

<div id="admin-data" data-students="{{ total_students|default:0 }}" data-alumni="{{ total_alumni|default:0 }}"
    data-companies="{{ active_companies|default:0 }}" data-drives="{{ drives_this_month|default:0 }}"
    data-labels="{{ chart_labels|safe }}" data-scores="{{ chart_data|safe }}" style="display:none;">
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stats-card p-4 h-100 shadow-sm">
            <h6 class="text-secondary small fw-bold text-uppercase mb-3">Total Students</h6>
            <h2 class="fw-bold mb-0">{{ total_students }}</h2>
            <div class="mt-2 small text-success"><i class="bi bi-person-check-fill me-1"></i>Registry Active</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card p-4 h-100 shadow-sm">
            <h6 class="text-secondary small fw-bold text-uppercase mb-3">Alumni Base</h6>
            <h2 class="fw-bold mb-0">{{ total_alumni }}</h2>
            <div class="mt-2 small text-muted"><i class="bi bi-shield-fill-check me-1"></i>Mentor Verified</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card p-4 h-100 shadow-sm">
            <h6 class="text-secondary small fw-bold text-uppercase mb-3">Partners</h6>
            <h2 class="fw-bold mb-0">{{ active_companies }}</h2>
            <div class="mt-2 small text-warning"><i class="bi bi-building-fill me-1"></i>Growth Active</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card p-4 h-100 shadow-sm">
            <h6 class="text-secondary small fw-bold text-uppercase mb-3">Monthly Drives</h6>
            <h2 class="fw-bold mb-0">{{ drives_this_month }}</h2>
            <div class="mt-2 small text-info"><i class="bi bi-calendar-check me-1"></i>Sessions Live</div>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
                        <i class="bi bi-file-earmark-pdf text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0" id="reportModalLabel">Strategic Reports</h5>
                        <p class="text-muted small mb-0">Generate comprehensive PDF analysis</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-4">
                <form action="{% url 'generate_report' %}" method="GET" class="row g-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold text-secondary text-uppercase">Report Type</label>
                        <select name="type" class="form-select border-0 bg-light rounded-3" id="reportType">
                            <option value="feedback">Feedback Analysis</option>
                            <option value="student">Student Readiness</option>
                            <option value="comprehensive">Comprehensive Audit</option>
                        </select>
                    </div>
                    <div class="col-12" id="alumniFilter">
                        <label class="form-label small fw-bold text-secondary text-uppercase">Alumni Filter</label>
                        <select name="alumni_id" class="form-select border-0 bg-light rounded-3">
                            <option value="">All Alumni</option>
                            {% for alumni in alumni_list %}
                            <option value="{{ alumni.id }}">{{ alumni.get_full_name|default:alumni.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12" id="companyFilter">
                        <label class="form-label small fw-bold text-secondary text-uppercase">Company Filter</label>
                        <select name="company_id" class="form-select border-0 bg-light rounded-3">
                            <option value="">All Companies</option>
                            {% for company in company_list %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 mt-4">
                        <button type="submit" class="btn btn-primary w-100 rounded-3 py-2 fw-bold">
                            <i class="bi bi-lightning-fill me-2"></i>Generate PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card p-0 border-0 shadow-sm h-100"
            style="border-radius: 24px; overflow: hidden; background: #0f172a;">
            <div class="p-4 d-flex justify-content-between align-items-center position-absolute w-100"
                style="z-index: 10; pointer-events: none;">
                <h5 class="fw-bold text-white mb-0">Performance Analytics</h5>
                <span class="badge bg-primary rounded-pill px-3 py-2" style="pointer-events: auto;">3D Bar Core</span>
            </div>
            <div id="canvas-wrapper"
                style="width: 100%; height: 450px; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); position: relative;">
                <div id="graph-tooltip"
                    style="position: absolute; display: none; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); color: white; padding: 12px; border-radius: 12px; border: 1px solid rgba(79, 70, 229, 0.5); pointer-events: none; z-index: 100; font-family: 'Inter', sans-serif; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                </div>
            </div>
            <div class="p-4 border-top border-secondary">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="chart-container" style="height: 100px;"><canvas id="miniStatsChart"></canvas></div>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="text-secondary small fw-semibold">Live System Pulse</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card p-4 border-0 shadow-sm h-100" style="border-radius: 24px;">
            <h5 class="fw-bold mb-4">Operation Center</h5>
            <div class="mb-5">
                <a href="{% url 'company_create' %}" class="action-btn">
                    <i class="bi bi-plus-circle-fill text-primary"></i> Create Opportunity
                </a>
                <a href="{% url 'user_list' %}" class="action-btn">
                    <i class="bi bi-people-fill text-success"></i> Manage Users
                </a>
                <a href="{% url 'schedule_interview' %}" class="action-btn">
                    <i class="bi bi-calendar-event-fill text-info"></i> Scheduler Hub
                </a>
                <a href="#" class="action-btn" data-bs-toggle="modal" data-bs-target="#reportModal">
                    <i class="bi bi-file-earmark-pdf-fill text-danger"></i> Generate Reports
                </a>
                <a href="/admin/" class="action-btn">
                    <i class="bi bi-gear-fill text-secondary"></i> System Settings
                </a>
            </div>

            <div class="mt-auto p-4 rounded-4" style="background: #f8f9fa;">
                <h6 class="fw-bold small mb-2 text-uppercase text-secondary">System Health</h6>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success rounded-pill" style="width: 82%"></div>
                </div>
                <div class="d-flex justify-content-between small">
                    <span class="text-muted">Stability Index</span>
                    <span class="fw-bold text-dark">99.9%</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    (function () {
        const wrapper = document.getElementById('canvas-wrapper');
        const tooltip = document.getElementById('graph-tooltip');
        const dataNode = document.getElementById('admin-data');
        if (!wrapper || !dataNode) return;

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, wrapper.clientWidth / wrapper.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(wrapper.clientWidth, wrapper.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        wrapper.appendChild(renderer.domElement);

        const group = new THREE.Group();
        scene.add(group);

        const data = [
            { label: 'Students', value: parseInt(dataNode.dataset.students) || 0, color: 0x4f46e5 },
            { label: 'Alumni', value: parseInt(dataNode.dataset.alumni) || 0, color: 0x10b981 },
            { label: 'Companies', value: parseInt(dataNode.dataset.companies) || 0, color: 0xf59e0b },
            { label: 'Drives', value: parseInt(dataNode.dataset.drives) || 0, color: 0x06b6d4 }
        ];

        const maxVal = Math.max(...data.map(d => d.value), 10);
        const scale = 7 / maxVal;

        // Platform
        const platform = new THREE.Mesh(
            new THREE.CylinderGeometry(6, 6.5, 0.5, 32),
            new THREE.MeshPhongMaterial({ color: 0x1e293b, transparent: true, opacity: 0.8 })
        );
        platform.position.y = -0.3;
        group.add(platform);

        const bars = [];
        data.forEach((item, i) => {
            const h = Math.max(item.value * scale, 1.5);
            const geometry = new THREE.BoxGeometry(1.5, h, 1.5);
            const material = new THREE.MeshPhongMaterial({
                color: item.color,
                shininess: 100,
                transparent: true,
                opacity: 0.9
            });
            const bar = new THREE.Mesh(geometry, material);

            const angle = (i / data.length) * Math.PI * 2;
            const radius = 3.5;
            bar.position.set(Math.cos(angle) * radius, h / 2, Math.sin(angle) * radius);
            bar.lookAt(0, h / 2, 0);
            bar.userData = { label: item.label, value: item.value };

            // Styled Edges
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.4 }));
            bar.add(line);

            bars.push(bar);
            group.add(bar);

            // Animation
            bar.scale.y = 0.01;
            bar.position.y = 0;
            const grow = () => {
                if (bar.scale.y < 1) {
                    bar.scale.y += 0.04;
                    bar.position.y = (h * bar.scale.y) / 2;
                    requestAnimationFrame(grow);
                }
            };
            setTimeout(grow, i * 150);
        });

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 15, 10);
        scene.add(light);

        camera.position.set(12, 12, 12);
        camera.lookAt(0, 2, 0);

        const rc = new THREE.Raycaster();
        const m = new THREE.Vector2();

        wrapper.addEventListener('mousemove', (e) => {
            const rect = wrapper.getBoundingClientRect();
            m.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            m.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            rc.setFromCamera(m, camera);

            const intersects = rc.intersectObjects(bars);
            bars.forEach(b => {
                b.scale.set(1, 1, 1);
            });

            if (intersects.length > 0) {
                const b = intersects[0].object;
                b.scale.set(1.1, 1.1, 1.1);
                wrapper.style.cursor = 'pointer';
                tooltip.style.display = 'block';
                tooltip.innerHTML = `<strong>${b.userData.label}</strong><br>Status: ${b.userData.value} Records`;
                tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                tooltip.style.top = (e.clientY - rect.top - 15) + 'px';
            } else {
                wrapper.style.cursor = 'default';
                tooltip.style.display = 'none';
            }
        });

        const animate = () => {
            requestAnimationFrame(animate);
            group.rotation.y += 0.002;
            renderer.render(scene, camera);
        };
        animate();

        // Mini Stats Chart
        const ctx = document.getElementById('miniStatsChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: JSON.parse(dataNode.dataset.labels.replace(/'/g, '"')),
                datasets: [{
                    data: JSON.parse(dataNode.dataset.scores),
                    borderColor: '#4f46e5',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } }
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = wrapper.clientWidth / wrapper.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(wrapper.clientWidth, wrapper.clientHeight);
        });
    })();

    // Report Type Filter Logic
    const reportType = document.getElementById('reportType');
    const alumniFilter = document.getElementById('alumniFilter');
    const companyFilter = document.getElementById('companyFilter');

    if (reportType) {
        reportType.addEventListener('change', function () {
            if (this.value === 'feedback') {
                alumniFilter.style.display = 'block';
                companyFilter.style.display = 'block';
            } else {
                alumniFilter.style.display = 'none';
                companyFilter.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}